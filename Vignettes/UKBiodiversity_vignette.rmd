---
title: "Recreate UK Biodiversity trends paper"
author: "Charlotte L. Outhwaite"
date: "08/06/2019"
output:
  pdf_document:
    toc: true 
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This vignette uses the UKBiodiversity R package to recreate the figures generated in the paper "" by Outhwaite et al.


# Set up R environment

First you will need to download the datasets used.  These data are freely available from the EIDC [repository](https://catalogue.ceh.ac.uk/documents/0ec7e549-57d4-4e2d-b2d3-2199e1578d84) and are described in full in the accompanying data paper (REF).  

In the repository you will find the following items:

* POSTERIOR_SAMPLES: zip file containing 1 file per species of the posterior samples
* SUMMARY_TABLES: zip file containing 1 file per species of model output summary tables
* Dataset_Information: csv file containing input data metadata
* Species_Names: csv file containing information on species names
* Species_Trends: csv file containing all estimates of species trends

For this analysis you will need to unzip the POSTERIOR_SAMPLES folder and set this folder as the working directory using the function `setwd()`.



## Generation gof roup level posterior sample datasets

For some of the analyses we will need a matrix containing all the posterior samples of the species within each of the major groups and also for each of the taxa level groups.  In the repository, the posterior samples for each species are saved as individual csv files, one for each species.  Use the `combine_posteriors` function to make the required combinations of the posteriors by group and save these as .rdata files. 

```{r combine_posteriors, echo = TRUE}


# Set working directory
datadir <- ("C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Repository downloads")

# Take a look at files within the POSTERIOR_SAMPLES folder
head(ist.files(datadir))

# Run for major groups (4 groups)
outdir_mg <- dir.create(paste0(getwd(), "/Major_groups"))

combine_posteriors(dir = getwd(), outdir = outdir_mg, group_level = "major_groups")

# Run for taxa (31 groups)
outdir_taxa <- dir.create(paste0(getwd(), "/Taxa"))

combine_posteriors(dir = getwd(), outdir = outdir_taxa, group_level = "major_groups")



```






# Recreating Figure 1 and associated trend estimates



```{r generate_fig1, echo = TRUE}




# Testing combine posteriors function
combine_posteriors(group_level = "taxa",
                   datadir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Repository downloads",
                   outdir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Package_testing",
                   status = TRUE)

# testing generate fig 1 function
generate_fig1(postdir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Package_testing/MajorGroups")


# testing group_trends function
trends <- group_trends(datadir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Package_testing/MajorGroups/geomeans")

# testing generate fig 2 function
generate_fig2(datadir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Package_testing/MajorGroups/geomeans")


# testing generate_fig3 function - this takes a while to run.
generate_fig3(postdir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Package_testing/MajorGroups")


# testing generate fig 4 function
generate_fig4(postdir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Package_testing/Taxa")


# testing generate_fig5 function - this takes a while to run.
generate_fig5(postdir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Repository downloads/POSTERIOR_SAMPLES",
              outdir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Package_testing",
              sp_trends = read.csv("C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Repository downloads/Species_Trends.csv"))

# testing generate_fig1supp function - this takes a while to run
generate_fig1supp(postdir = "C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Package_testing/MajorGroups",
                  sp_trends = read.csv("C:/Users/charl/Dropbox/PhD WORK/1. BIG PAPER/Repository downloads/Species_Trends.csv"))



